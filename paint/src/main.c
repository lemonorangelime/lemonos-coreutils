#include <graphics.h>
#include <widgets.h>
#include <sched.h>
#include <string.h>
#include <main.h>

uint32_t icon[]  = {
	0x00000080, 0x00000080, 0x00000080, 0x00000080, 0x00000080, 0x00000080, 0xfffeb300, 0xffffb300, 0xfffeb200, 0xfffeb300, 0x00000080, 0x00000080, 0x00000080, 0x00000080, 0x00000080, 0x00000080, 
	0x00000080, 0x00000080, 0x00000080, 0xffffb301, 0xffffb201, 0xfffeb201, 0xfffec106, 0xfffec107, 0xfffec107, 0xfffec006, 0xffffb301, 0xfffeb300, 0xffffb301, 0x00000080, 0x00000080, 0x00000080, 
	0x00000080, 0x00000080, 0xfffeb200, 0xffffc106, 0xffffc007, 0xfffec006, 0xfffef59c, 0xfffef49d, 0xfffef59c, 0xfffef59d, 0xffffc107, 0xfffec006, 0xffffc007, 0xfffeb200, 0x00000080, 0x00000080, 
	0x00000080, 0xfffeb301, 0xffffc006, 0xfffff59c, 0xfffff59c, 0xfffec007, 0xfffec106, 0xfffff9c5, 0xfffff9c5, 0xfffef59d, 0xffffc006, 0xfffec107, 0xfffef49d, 0xfffec106, 0xffffb201, 0x00000080, 
	0x00000080, 0xfffeb300, 0xfffec006, 0xfffff59c, 0xfffff9c5, 0xfffef9c4, 0xffffc106, 0xfffec006, 0xfffff9c5, 0xfffec007, 0xffffc107, 0xfffef8c4, 0xfffff49d, 0xfffec006, 0xffffb200, 0x00000080, 
	0xfffeb301, 0xfffec006, 0xfffef59d, 0xfffef8c5, 0xfffff9c4, 0xfffef9c5, 0xfffff9c5, 0xffffc107, 0xfffef8c5, 0xffffc006, 0xfffec006, 0xfffef9c4, 0xfffff9c5, 0xfffef59c, 0xfffec007, 0xfffeb301, 
	0xfffeb301, 0xffffc107, 0xffffc007, 0xffffc106, 0xfffef9c4, 0xfffef9c5, 0xffffc106, 0xffffc007, 0xffffc007, 0xfffec007, 0xffffc106, 0xffffc006, 0xffffc107, 0xfffec006, 0xfffec006, 0xfffeb300, 
	0xfffeb200, 0xfffec007, 0xffffc107, 0xfffec107, 0xfffec106, 0xfffec006, 0xffffc107, 0xfffff9c5, 0xfffff8c4, 0xfffec107, 0xfffff8c5, 0xfffef8c5, 0xfffec006, 0xfffec106, 0xffffc107, 0xfffeb201, 
	0xfffeb300, 0xffffc007, 0xfffef59d, 0xfffef59c, 0xfffff8c5, 0xfffff8c5, 0xfffec006, 0xfffff9c4, 0xfffef9c4, 0xfffec007, 0xfffef8c4, 0xfffef8c5, 0xfffff9c5, 0xfffff8c4, 0xfffec007, 0xfffeb200, 
	0xfffeb300, 0xffffc007, 0xfffff59c, 0xfffef9c4, 0xfffec106, 0xffffc007, 0xfffec006, 0xffffc106, 0xfffec006, 0xfffec007, 0xffffc007, 0xfffef59c, 0xfffff9c5, 0xfffef49c, 0xfffec007, 0xffffb301, 
	0xffffb301, 0xffffc006, 0xfffec006, 0xfffec107, 0xffffc006, 0xfffff9c5, 0xffffc006, 0xfffff8c4, 0xffffc107, 0xfffef8c5, 0xfffec106, 0xffffc106, 0xfffff49c, 0xfffff59c, 0xffffc107, 0xfffeb200, 
	0x00000080, 0xfffeb201, 0xfffec006, 0xfffff49d, 0xfffef9c5, 0xfffec106, 0xffffc106, 0xfffff8c5, 0xfffec107, 0xfffff8c4, 0xfffff9c5, 0xfffec107, 0xfffff49c, 0xffffc106, 0xfffeb301, 0x00000080, 
	0x00000080, 0xffffb201, 0xffffc106, 0xfffef59c, 0xfffef59c, 0xfffec006, 0xfffef59c, 0xfffff9c5, 0xfffec007, 0xfffef8c5, 0xfffff59c, 0xffffc106, 0xfffec106, 0xffffc106, 0xffffb301, 0x00000080, 
	0x00000080, 0x00000080, 0xfffeb201, 0xfffec006, 0xffffc107, 0xffffc106, 0xfffff59c, 0xfffff59d, 0xfffec006, 0xfffef59d, 0xfffec107, 0xffffc006, 0xffffc007, 0xffffb201, 0x00000080, 0x00000080, 
	0x00000080, 0x00000080, 0x00000080, 0xffffb200, 0xffffb200, 0xfffeb300, 0xfffec106, 0xfffec007, 0xfffec107, 0xfffec106, 0xfffeb301, 0xffffb201, 0xfffeb200, 0x00000080, 0x00000080, 0x00000080, 
	0x00000080, 0x00000080, 0x00000080, 0x00000080, 0x00000080, 0x00000080, 0xffffb300, 0xfffeb301, 0xfffeb201, 0xffffb201, 0x00000080, 0x00000080, 0x00000080, 0x00000080, 0x00000080, 0x00000080
};

void hold_start(widgets_screen_t * screen, widgets_element_t * element, widgets_mouseevent_t * event) {
	mouse_event_t * real_event = (mouse_event_t *) event->event;
	priv_t * priv = widgets_get_priv(element);
	rect_2d_t * rect = priv->rect;
	rect->fb[(real_event->y * rect->size.width) + real_event->x] = 0xffffffff;
}

void hold_end(widgets_screen_t * screen, widgets_element_t * element, widgets_mouseevent_t * event) {
	mouse_event_t * real_event = (mouse_event_t *) event->event;
	priv_t * priv = widgets_get_priv(element);
	rect_2d_t * rect = priv->rect;
	rect->fb[(real_event->y * rect->size.width) + real_event->x] = 0xffffffff;
}

void hold_drag(widgets_screen_t * screen, widgets_element_t * element, widgets_mouseevent_t * event) {
	mouse_event_t * real_event = (mouse_event_t *) event->event;
	priv_t * priv = widgets_get_priv(element);
	rect_2d_t * rect = priv->rect;
	rect->fb[(real_event->y * rect->size.width) + real_event->x] = 0xffffffff;
}

int main(int argc, char * argv[]) {
	window_t * window = create_window(u"LemonOS Paint", u"paint", 300, 200);
	widgets_screen_t * screen = widgets_create_screen(window);
	widgets_element_t * hitbox = widgets_create_hitbox(300, 200);
	widgets_add_element(screen, hitbox);

	widgets_register_handler(hitbox, WIDGETS_ONMOUSEDOWN, hold_start);
	widgets_register_handler(hitbox, WIDGETS_ONMOUSEUP, hold_end);
	widgets_register_handler(hitbox, WIDGETS_ONMOUSEMOVE, hold_drag);

	priv_t priv;
	memset(&priv, 0, sizeof(priv_t));
	priv.colour = 0xff000000;
	priv.hitbox = hitbox;
	priv.rect = &window->rect;
	widgets_set_priv(hitbox, &priv);

	widgets_update_screen(screen);
	while (1) {
		sched_yield();
	}
	return 0;
}
